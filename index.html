<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>The Crypto Chronicle — Blockwall Intelligence</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS v4 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>

  <!-- DOMPurify for XSS sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

  <!-- Chart.js for dashboard visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- Custom styles -->
  <link rel="stylesheet" href="./css/custom.css">
</head>
<body class="min-h-screen">
  <div class="flex flex-col h-screen max-w-7xl mx-auto">

    <!-- ═══ Masthead ═══ -->
    <header class="flex-none px-6 pt-6 pb-0">
      <!-- Top rule -->
      <hr class="rule-line-gold mb-4">

      <!-- Masthead row -->
      <div class="flex items-center justify-between mb-1">
        <span class="text-xs tracking-widest uppercase" style="color: var(--text-secondary);">Blockwall Capital</span>
        <div class="flex items-center gap-3">
          <!-- Sync indicator -->
          <button
            id="sync-trigger"
            title="Sync latest articles"
            class="flex items-center gap-1.5 px-2.5 py-1 text-xs rounded-md glass glass-hover cursor-pointer"
            style="color: var(--text-secondary);"
          >
            <span id="sync-dot" class="w-1.5 h-1.5 rounded-full" style="background: var(--gold);"></span>
            <span id="sync-label">Synced</span>
          </button>
          <span class="text-xs" style="color: var(--text-muted);" id="masthead-date"></span>
        </div>
      </div>

      <!-- Title -->
      <h1 class="font-display text-4xl md:text-5xl font-black text-center tracking-tight mb-1" style="color: var(--text-primary);">
        The Crypto Chronicle
      </h1>
      <p class="text-center text-sm mb-3" style="color: var(--text-secondary);">
        Knowledge Graph Intelligence &mdash; Entities &bull; Trends &bull; Portfolio
      </p>

      <!-- Bottom rule -->
      <hr class="rule-line mb-0">

      <!-- Tab Navigation -->
      <nav role="tablist" class="flex justify-center gap-8 mt-0 pt-3 pb-2">
        <button
          role="tab"
          data-tab="chat"
          aria-selected="true"
          class="px-1 pb-2 text-sm font-semibold tracking-wide uppercase transition-colors tab-active"
        >
          Chat
        </button>
        <button
          role="tab"
          data-tab="trends"
          aria-selected="false"
          class="px-1 pb-2 text-sm font-semibold tracking-wide uppercase transition-colors tab-inactive"
        >
          Trends
        </button>
        <button
          role="tab"
          data-tab="portfolio"
          aria-selected="false"
          class="px-1 pb-2 text-sm font-semibold tracking-wide uppercase transition-colors tab-inactive"
        >
          Portfolio
        </button>
      </nav>

      <hr class="rule-line">
    </header>

    <!-- ═══ Tab Panels ═══ -->
    <main class="flex-1 overflow-y-auto">

      <!-- Chat Panel (Default Active) -->
      <div data-panel="chat" role="tabpanel" aria-hidden="false" class="flex flex-col h-full">
        <!-- Pipeline Status -->
        <div id="pipeline-status" class="hidden px-6 py-2" role="status" aria-live="polite">
          <div class="flex items-center gap-2 text-sm" style="color: var(--text-secondary);">
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="pipeline-message">Processing...</span>
          </div>
        </div>

        <!-- Messages Container -->
        <div id="messages" class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
          <div id="suggestions" class="flex flex-col gap-3"></div>
        </div>

        <!-- Input Form -->
        <form id="chat-form" class="flex-none px-6 pb-5 pt-3">
          <div class="flex gap-3">
            <input
              type="text"
              id="question-input"
              placeholder="Ask about crypto entities, trends, or portfolio..."
              class="flex-1 glass px-4 py-3 text-sm focus:outline-none"
              style="color: var(--text-primary); background: var(--bg-surface);"
              autocomplete="off"
              aria-label="Enter your question about crypto entities, trends, or portfolio"
            />
            <button
              type="submit"
              id="send-button"
              class="px-6 py-3 rounded-xl font-semibold text-sm transition-all cursor-pointer disabled:opacity-40 disabled:cursor-not-allowed"
              style="background: var(--gold); color: var(--bg-deep);"
              aria-label="Send question"
            >
              Send
            </button>
          </div>
        </form>
      </div>

      <!-- Trends Panel -->
      <div data-panel="trends" role="tabpanel" aria-hidden="true" class="hidden p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass p-5" style="height:400px">
            <canvas id="trending-topics-chart"></canvas>
          </div>
          <div class="glass p-5" style="height:400px">
            <canvas id="sentiment-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Portfolio Panel -->
      <div data-panel="portfolio" role="tabpanel" aria-hidden="true" class="hidden p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <h2 class="font-display text-2xl font-bold mb-4" style="color: var(--text-primary);">Portfolio Companies</h2>
            <div id="portfolio-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          </div>
          <div>
            <h2 class="font-display text-2xl font-bold mb-4" style="color: var(--text-primary);">Recent Funding</h2>
            <div id="funding-alerts" class="space-y-3"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Entity Modal -->
  <div id="entity-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0,0,0,0.70); backdrop-filter: blur(8px);" role="dialog" aria-modal="true" aria-labelledby="entity-modal-title">
    <div class="glass max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6">
      <div class="flex justify-between items-start mb-4">
        <h2 id="entity-modal-title" class="font-display text-xl font-bold" style="color: var(--text-primary);"></h2>
        <button id="entity-modal-close" class="text-2xl cursor-pointer" style="color: var(--text-secondary);" aria-label="Close entity modal">&times;</button>
      </div>
      <div id="entity-modal-content" style="color: var(--text-secondary);"></div>
    </div>
  </div>

  <!-- Main application script -->
  <script type="module" src="./js/main.js"></script>

  <!-- Masthead date + sync button -->
  <script>
    // Set current date in masthead
    document.getElementById('masthead-date').textContent =
      new Intl.DateTimeFormat('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).format(new Date());

    // Sync button handler
    document.getElementById('sync-trigger').addEventListener('click', async function() {
      const dot = document.getElementById('sync-dot');
      const label = document.getElementById('sync-label');
      label.textContent = 'Syncing...';
      dot.classList.add('sync-pulse');
      try {
        const API = window.__API_BASE || 'https://blockwall-kg-api.onrender.com';
        const res = await fetch(API + '/api/sync', { method: 'POST' });
        const data = await res.json();
        label.textContent = data.new_articles > 0 ? `+${data.new_articles} new` : 'Up to date';
        setTimeout(() => { label.textContent = 'Synced'; }, 4000);
      } catch(e) {
        label.textContent = 'Sync failed';
        setTimeout(() => { label.textContent = 'Synced'; }, 4000);
      }
      dot.classList.remove('sync-pulse');
    });
  </script>
</body>
</html>
